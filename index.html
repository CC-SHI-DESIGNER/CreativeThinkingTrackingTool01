<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tracing Creative Thinking Tool</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; background: #0b0f19; color: white; display: flex; font-family: system-ui; }
        #canvas { flex: 1; height: 100vh; }
        #panel { width: 400px; background: #161b22; border-left: 1px solid #30363d; padding: 20px; overflow-y: auto; }
        .node { stroke: #fff; stroke-width: 1.5px; }
        .link { stroke: #444; stroke-opacity: 0.6; }
        .sketch-img { width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #38bdf8; }
        .xot-box { background: #23863622; border: 1px solid #238636; padding: 10px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="canvas"></div>
    <div id="panel">
        <h2 id="title">點擊節點開始追蹤</h2>
        <div id="content">
            <p>請選擇一個綠色（人類）或橙色（AI）節點查看思維演化過程。</p>
        </div>
        <img id="sketch-display" class="sketch-img" style="display:none;">
    </div>

    <script>
        const width = window.innerWidth - 400;
        const height = window.innerHeight;

        d3.json("data.json").then(data => {
            const svg = d3.select("#canvas").append("svg").attr("width", width).attr("height", height);
            
            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-150))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g").selectAll("line").data(data.links).enter().append("line").attr("class", "link");

            const node = svg.append("g").selectAll("circle").data(data.nodes).enter().append("circle")
                .attr("class", "node")
                .attr("r", d => d.level === 0 ? 15 : (d.level === 1 ? 8 : 5))
                .attr("fill", d => d.group === 0 ? "#38bdf8" : (d.group === 1 ? "#4ade80" : "#fbbf24"))
                .on("click", (e, d) => showDetails(d))
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

            function showDetails(d) {
                if(d.group === 0) return;
                document.getElementById("title").innerText = d.label;
                let html = `<p><strong>類型:</strong> ${d.items || "AI 衍生創意"}</p>`;
                html += `<p><strong>設計描述:</strong> ${d.details || "基於「" + d.parent_feat + "」的 XoT 推演"}</p>`;
                
                if(d.group === 2) {
                    html += `<div class="xot-box"><strong>XoT 推理:</strong> 檢索原始特徵，通過「Everything of Thoughts」框架模擬設計師思維分叉，生成此優化路徑。</div>`;
                }
                
                document.getElementById("content").innerHTML = html;
                
                const img = document.getElementById("sketch-display");
                if(d.sketch) {
                    img.src = "../" + d.sketch; // 指向根目錄下的 data/sketches
                    img.style.display = "block";
                } else {
                    img.style.display = "none";
                }
            }

            // D3 Simulation Tick
            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                node.attr("cx", d => d.x).attr("cy", d => d.y);
            });

            // Drag Functions... (略，同之前代碼)
        });
        function dragstarted(event) { if (!event.active) simulation.alphaTarget(0.3).restart(); event.subject.fx = event.subject.x; event.subject.fy = event.subject.y; }
        function dragged(event) { event.subject.fx = event.x; event.subject.fy = event.y; }
        function dragended(event) { if (!event.active) simulation.alphaTarget(0); event.subject.fx = null; event.subject.fy = null; }
    </script>
</body>
</html>
